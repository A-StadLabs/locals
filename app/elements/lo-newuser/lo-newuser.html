<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animated-pages.html">

<link rel="import" href="../dp-pin/dp-pin.html">

<link rel="import" href="../lo-xmpp/lo-xmpp.html">



<link rel="import" href="../../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/slide-from-right-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/slide-left-animation.html">

<link rel="import" href="../../bower_components/neon-animation/neon-animatable.html">

<script src="../../bower_components/node-uuid/uuid.js"></script>
<script src="../../scripts/crypto-aes.js"></script>
<!-- <script src="../../scripts/labs-locals.js"></script>
 -->
<dom-module id="lo-newuser">
  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
      }

      neon-animated-pages {
        height: 100%;
      }
    </style>

    <iron-localstorage id="localstorage" name="labs002-user" value="{{encruserid}}">
    </iron-localstorage>

     <iron-localstorage 
      name="labs002-openfire2" 
      value="{{openfireuser2}}">
    </iron-localstorage>

     <iron-localstorage 
      name="labs002-openfire1" 
      value="{{openfireuser1}}"
      on-iron-localstorage-load="loginOpenfire">
    </iron-localstorage>

    <iron-localstorage 
      id="localstorage" 
      name="labs002-data" 
      value="{{encdata}}">
  </iron-localstorage>

    <lo-xmpp id="loxmpp" username="{{openfireuser1}}" password="{{openfireuser2}}" on-msg-received="msgreceived"></lo-xmpp>


    <neon-animated-pages id="pages" selected="{{selected}}" entry-animation="{{entryAnimation}}" exit-animation="{{exitAnimation}}">

      <dp-pin on-pin-entered="naarPin2" pin="{{pin1}}" titel="Kies een pincode." error="{{error}}" extrabtn="Ik heb al een toestel geactiveerd" on-naar-activ="naarActivatie"></dp-pin>

      <dp-pin on-pin-entered="naarPinCheck" pin="{{pin2}}" titel="Herhaal de pincode." error="{{error}}">
        </dp-pin>

      <neon-animatable>
        <div class="canvas layout vertical center-center color">
        <h2>Registratie voltooid.</h2>
        <p>Je hebt een nieuwe gebruiker aangemaakt op dit toestel.</p>
        <button on-tap="reload">Ga verder</button>
      </div>
      </neon-animatable>

      <neon-animatable>
        <labs002-qrreader 
          on-got-code="transferUser"></labs002-qrreader>
      </neon-animatable>

    </neon-animated-pages>
  </template>
  <script>
  (function() {
    'use strict';

    var domein = "opantwerpen.be";

    function importPage(url){
    return new Promise(function(resolve, reject){
      Polymer.Base.importHref(url, function(e){
        resolve(e.target.import);
      }, reject);
    });
  };

    Polymer({
      is: 'lo-newuser',

      properties: {
        
      },

      attached: function(){
        this.selected = 0;
        this.entryAnimation = 'slide-from-right-animation';
        this.exitAnimation = 'slide-left-animation';
      },

      reload: function(){
        window.location = "/";
      },

      naarPin2: function(){
        this.selected = 1;
      },

      msgreceived: function(e){
        console.log(e.detail.detail[1].command);
        var partner = e.detail.detail[0].partner;
        if(e.detail.detail[1].command){
          this.encdata = e.detail.detail[4].objectdata;
          this.encruserid = e.detail.detail[3].objectconfig;
          //this.$.localstorageapi.lastupdate = Date.now();
          this.$.loxmpp.sendMessage(partner, "SYNCOK", null, null, null);
          window.location = "/";
        };
      },

      naarPinCheck: function(){
        if(this.pin1==this.pin2){
          console.log('Pincodes komen overeen');
          this.createUser();
        } else {
          console.log('Pincodes niet gelijk');
          this.error = "Pins komen niet overeen.";
          this.selected = 0;
          this.pin1 = '';
          this.pin2 = '';
        };
    },

    createUser: function(){
      var userid = uuid.v1();
      var pincode = this.pin1;
      console.log('--- Created UUID ---');
      console.log('--- userid: ', userid, ' - pincode: ', pincode, ' ---');

      var tmpuserid = CryptoJS.AES.encrypt(userid, pincode);
      console.log('--- Encrypted UUID ---');
      this.encruserid = tmpuserid.toString();
      //this.$.localstorage.value = this.encruserid;
      console.log('--- Stored encrypted UUID in localstorage ---');
      this.selected=2;
    },

    naarActivatie: function(){
      this.$.loxmpp.login();
      var that = this;
      importPage("elements/labs002-qrreader/labs002-qrreader.html").then(function(){
        //var element = document.createElement("labs002-stage");
        //body.appendChild(element);
        that.selected = 3;
      }, function(err){
        console.log(err, "error");
      });
    },

    transferUser: function(e){
      console.log("Gonna sync with this user: ", e.detail.partner);
      var partner = e.detail.partner+'@'+domein;
      console.log(partner);
      this.$.loxmpp.sendMessage(partner, "SYNC", null, null, null);
    }


    });
  })();
  </script>
</dom-module>
