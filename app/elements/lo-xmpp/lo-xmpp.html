<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src="../../bower_components/strophe.js/strophe.js"></script>
<script src="../../bower_components/strophejs-plugins/muc/strophe.muc.js"></script>
<script src="../../bower_components/strophe-openfire-websocket/strophe-openfire-websocket.js"></script>

<dom-module id="lo-xmpp">

  <script>
  (function() {
    'use strict';

    var conn;

    var me; 

    Polymer({
      is: 'lo-xmpp',

      properties: {
        username: {
          type: String,
          value: '',
          notify: true
        },
        password: {
          type: String,
          value: '',
          notify: true
        },
        domein: {
          type: String,
          value: '@opantwerpen.be',
          notify: true
        },
        server: {
          type: String,
          value: 'ws://www.opantwerpen.be:7070/ws/server',
          notify: true
        },
        loggedin: {
          type: Boolean,
          notify: true,
          value: false
        }
        
      },

      attached: function(){
        me = this;
      },

      login: function(){

        conn = new Openfire.Connection(this.server, function(e){
          console.log(e);
        });

        var that = this;

        conn.connect(this.username, this.password, function(status){
          console.log(status);
          if (status === Strophe.Status.CONNECTED) {
              // Als em goed is ingelogd doe dit
              
              conn.send($pres().tree());
              
              conn.addHandler(that.receiveMessage);
              that.connected = true;
              that.loggedin = true;
              fn();
          } else if (status === Strophe.Status.DISCONNECTED) {
            // Als er iets fout ging met login doe dit
              console.log('--- Diconnected from OpenFire');
          };
        });
      },

      receiveMessage: function(msg){
        //console.log(msg);
        var that = this;
        var to = msg.getAttribute('to');
        var from = msg.getAttribute('from');
        var type = msg.getAttribute('type');
        var elems = msg.getElementsByTagName('body');
        
        //console.log("Body: ", elems);
        var body = elems[0];
        if(body!=null){

          var bodymsg = Strophe.getText(body);
          bodymsg = Strophe.xmlunescape(bodymsg);

          var commandarray = bodymsg.split("//");

          var partner = from;
          var command = commandarray[0];
          var objectname = commandarray[1];
          var objectconfig = commandarray[2];
          var objectdata = commandarray[3];

          //processCommand(partner, command, objectname, objectconfig, objectdata);
          //console.log("processCommand: ", partner, command, objectname, objectconfig, objectdata);
        };
        me.fire("msg-received", 
          { detail: [{ "partner": partner }, 
                    { "command": command },
                    { "objectname": objectname },
                    { "objectconfig": objectconfig },
                    { "objectdata": objectdata }]
        });
        return true;
      }
    });
  })();
  </script>
</dom-module>
