<!-- Copyright (c) 2015 The Locals Project Authors. All rights reserved.
See authors.md for a list of all members.
 -->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src="../../scripts/crypto-aes.js"></script>

<link rel="import" href="../dp-pin/dp-pin.html">

<link rel="import" href="../lo-xmpp/lo-xmpp.html">

<link rel="import" href="../../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/slide-from-right-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/slide-left-animation.html">

<link rel="import" href="../../bower_components/neon-animation/neon-animatable.html">

<link rel="import" href="../labs002-localstorageapi/labs002-localstorageapi.html">
<link rel="import" href="../labs002-objectscollection/labs002-objectscollection.html">
<link rel="import" href="../alabs-qrcode/alabs-qrcode.html">
<link rel="import" href="../lo-dialog/lo-dialog.html">
<link rel="import" href="../lo-godfather/lo-godfather.html">


<dom-module id="labs002-stage">
<style>
  :host {
    display: block;
    --page-color:  var(--primary-blue);
    width: 100%;
    height: 100%;
  }

  .canvas {
    background-color: var(--page-color);
    color: white; 
    height: 100%;
    @apply(--layout-vertical);
    @apply(--layout-center-center);
    text-align: center;
  }

  .color {
    background-color: var(--page-color);
  }

  neon-animated-pages {
    height: 100%;
  }

  labs002-objectscollection {
    height: 100%;
  }

</style>
<template>

  <iron-localstorage 
    id="localstorage" 
    name="labs002-user" 
    value="{{encruserid}}">
  </iron-localstorage>

  <iron-localstorage 
    id="openfire1" 
    name="labs002-openfire1" 
    value="{{openfire1}}">
  </iron-localstorage>
  
  <iron-localstorage 
    id="openfire2" 
    name="labs002-openfire2" 
    value="{{openfire2}}"
    on-iron-localstorage-load="loginOpenfire">
  </iron-localstorage>

  <labs002-localstorageapi 
    id="localapielem" 
    userid="{{userid}}" 
    pincode="{{pin1}}" 
    data="{{localapi}}" 
    encdata="{{localenc}}"
    deviceid="{{openfire1}}">
  </labs002-localstorageapi>

  <lo-xmpp id="loxmpp" username="{{openfire1}}" password="{{openfire2}}" on-msg-received="msgreceived" on-groupmsg-received="groupmsgreceived"></lo-xmpp>

  <small>{{userid}}</small>

  <neon-animated-pages id="pages" selected="{{selected}}" class="color" entry-animation="{{entryAnimation}}" exit-animation="{{exitAnimation}}">



  <!-- Stage 0: Pincode ingeven (bestaande gebruiker) -->
  <dp-pin on-yes="toggleDrawer" on-pin-entered="decryptUser" pin="{{pin1}}" titel="Geef je pincode in." error="{{error}}">
  </dp-pin>

  <!-- Stage 1: Alle datasets renderen -->
<!--   <button on-tap="_addDataset">+</button>
 -->  <labs002-objectscollection 
    id="objectcoll" 
    userid="{{userid}}" 
    objectsdata="{{localapi}}" 
    class="color"
    loggedin="{{loggedin}}">
  </labs002-objectscollection>

  <!-- Stage 2: De geopende state van het object -->
  <div id="objectplaceholder"></div>

  <!-- Stage 3: QR code lezer -->
  <neon-animatable>
    <div class="canvas">
      <labs002-qrreader></labs002-qrreader>
    </div>
  </neon-animatable>

  <!-- Stage 4: QR code / Identificatie weergeven -->
  <neon-animatable>
    <div class="canvas">
      <button on-tap="_toWhere">back</button>
      <alabs-qrcode code="{{openfire1}}"></alabs-qrcode>
    </div>
  </neon-animatable>

  <!-- Stage 5: Dialog: actie goedkeuren of weigeren. -->
  <lo-dialog 
    id="lodialog" 
    title="Bevestigen?" 
    body="Iemand wil iets." 
    command="SYNC"
    on-dialog-confirm="processCommand" 
    on-dialog-cancel="cancel">
  </lo-dialog>
  
  <!-- Stage 6: Plusmenu om objecten toe te voegen. -->
  <neon-animatable>
    <div class="canvas">
      <labs002-objectpicker userobjects="{{localapi}}"></labs002-objectpicker>
    </div>
  </neon-animatable>

    <!-- Stage 7: Godfather: ik ben godfather van volgende datasets/users: -->
  <neon-animatable>
    <div class="canvas">
      <lo-godfather id="godf" children="{{localapi.godfather}}"></lo-godfather>
    </div>
  </neon-animatable>

</neon-animated-pages>

</template>
</dom-module>
<script>
  (function() {

    function importPage(url){
    return new Promise(function(resolve, reject){
      Polymer.Base.importHref(url, function(e){
        resolve(e.target.import);
      }, reject);
    });
  };

    var conn; 

    var partner;

    var stage;


    var app = document.getElementById("app");

    //console.log(app);

    var saveEncuserobject = function(e){
      //console.log(e);
      app.localenc = e;
    };

    var changeStage = function(e){
      stage.selected = e;
    };

    Polymer({
      is: 'labs002-stage',

      properties: {

        selected: {
          type: Number
        },
        domein: {
          type: String,
          value: "opantwerpen.be"
        }

      },

      /**
     * Ready function to declare some variables and setup event listeners.
     */

      ready: function(){

        //Dit staat hier voor de gemakkelijkheid
        //this.pin1 = '1234';

        this.loggedin = false;

        this.selected = 0;

        this.entryAnimation = 'slide-from-right-animation';
        this.exitAnimation = 'slide-left-animation';

        var that = this;
        
        this.addEventListener('change-stage', function(e){
          //console.log('Changing stage', e);
          that.selected = e.detail.stage;
        });
        
        this.addEventListener('save', function(){
          //console.log('Saving whole dataset: ', this.localapi);
          //that.localapi = e.detail.dataset;
          that.$.localapielem.writeData();
        });

        this.addEventListener('object-picker', function(){
          importPage("elements/labs002-objectpicker/labs002-objectpicker.html").then(function(){
              //that._addDataset();
              that.selected = 6;
            }, function(err){
              console.log(err, "error");
            });
          
        });

        this.addEventListener('qr-identity', function(e){
          that._toQR();
        });

        this.addEventListener('qr-reader', function(e){
          that._qrreader(e);
        });
      

      },

      attached: function(){
        stage = document.querySelector("labs002-stage");
      },

      senduserobject: function(){
        //console.log('send user object to: ', partner, ' This value: ', this.localenc);
        this.localapi.peers.push(this.openfire1+'@'+domein);
        this.localapi.peers.push(partner);
        this.$.localapielem.writeData();
        this.sendMessage(partner, "heresuserobject",this.localenc, this.encruserid);
        this.$.localapielem.readData();
      },

      /** * Dees functie opent de qr reader en wacht tot em iets terug krijgt. */

      _qrreader: function(e){

         var loxmpp = this.$.loxmpp;

        this.importHref("../elements/labs002-qrreader/labs002-qrreader.html", function(g) {
          this.addEventListener("got-code", function(f){
            //Hier doet em shit als em een code terug krijgt. 
            //this.$.objectcoll.callback(e.detail);
            // console.log('Got Code.', f.detail.partner);
            // console.log('partner: ', f.detail.partner);
            // console.log('Action to perform: ', e.detail.command);
            // console.log('Dataset: ', e.detail.objectname);
            // console.log('Config: ', e.detail.objectconfig);
            // console.log('Data: ', e.detail.objectdata);
            // console.log('Userid: ', e.detail.userid);
            // console.log('HASH: ', e.detail.hash);
            var partner = f.detail.partner+"@"+this.domein;
            var command = e.detail.command;
            var objectname = e.detail.objectname;
            var objectdata = e.detail.objectdata;
            var objectconfig = e.detail.objectconfig;
            var userid = e.detail.userid;
            var hash = e.detail.hash;
            loxmpp.sendMessage(partner, command, objectname, objectconfig, objectdata, userid, hash);
          });
        // e.target.import is the import document.
        //console.log('import',e);
      }, function(g) {
        //console.log('import',e);
        // loading error
      });
        changeStage(3);
      },

      /** * Userobject decrypteren met ingegeven pin code */
      decryptUser: function(){
        var decrypted = CryptoJS.AES.decrypt(this.encruserid, this.pin1);
        var decrtostring = decrypted.toString(CryptoJS.enc.Utf8);
        
        this.userid = decrtostring;
        // loginOpenfire(this.openfire1, this.openfire2, function(){
        //   that.openfireconnect = true;        
        // });

        var that = this;

        this.$.loxmpp.login(this.userid, function(){
          //console.log("logged in");
          that.loggedin = true;
 
          that.$.localapielem.readData();
          that.$.godf._children();
          //console.log("godf func");
          that.selected = 1;
        });
        

      },   
 
      // Navigational stuff
      /** * This one shows the qr code associated with this device */
      _toQR:function(){
        this.selected = 4;
      },

    _toWhere:function(){
      this.entryAnimation = 'slide-from-left-animation';
      this.exitAnimation = 'slide-right-animation';
      this.selected = 1;
    },

    _toScanner: function(){
      this.selected = 3;
    },

    _ConfirmGetuige: function(e) {
      //console.log('Yes, bevestigd!', e.target.user);
      var partner = e.target.user;
      var dataset = e.target.dataset;
      this.sendMessage(partner, "confirmgetuige", dataset, data);
    },

    _CancelGetuige: function() {
      //console.log('Neen, annuleren!');
    },

     /** * Wordt nog niet gebruikt, maar deze functie doet JOIN in chatroom. */
    // joinRoom: function(username, password, room){
    //   var that = this;
    //   this.room = room;
    //   //console.log('--- User joins room "astadlabs"');
    //   var room = this.room+"@conference.kingflurkel.dtdns.net";
    //   var nick = username+"@kingflurkel.dtdns.net";
    //   var password = password;
    //   var history_attrs = null;
    //   conn.muc.join(room, nick, that.msg_handler_cb, that.pres_handler_cb, that.roster_cb, password, history_attrs);
    // },

    _addDataset: function(){
        //console.log("add dataset");
        var config = {};
        config["colors"] = ["blue", "red"];

        var objectdata = {};
        objectdata["username"] = "kingflurkel";

        var object = {};
        object["name"] = "SkeletonObject";
        object["data"] = objectdata;
        object["config"] = config;
        object["peers"] = [];
        object["component"] = "labs002-skeletonobject";

        this.localapi.collection[object.name] = object;
        this.$.localapielem.writeData();
      },

      msgreceived: function(e){
        //console.log(JSON.stringify(e.detail));
        // {"detail":[{"partner":"8dfb9a50-6107-11e5-aa8c-8da569b7f6e2@opantwerpen.be/7782ea43-1baa-9f7f-4a2e-9fa5cb4edb6f"},{"command":"SYNC"},{"objectname":"null"},{"objectconfig":"null"},{"objectdata":"null"}]}
        var partner = e.detail.detail[0].partner;
        var command = e.detail.detail[1].command;
        var objectname = e.detail.detail[2].objectname;
        var objectconfig = e.detail.detail[3].objectconfig;
        var objectdata = e.detail.detail[4].objectdata;
        var userid = e.detail.detail[5].userid;
        var hash = e.detail.detail[6].hash;

        var dialog = this.$.lodialog;

        if(command){
          switch(command){
            case "SYNC":
              // Een ander toestel wil met dit toestel syncen.
              //console.log("sync request");
              dialog.title = "SYNC?";
              dialog.body = "Een toestel wil synchroniseren met dit toestel.";
              dialog.command = command;
              dialog.partner = e.detail.detail[0].partner;
              this.selected = 5;
            break;

            case "SYNCOK":
              //console.log("Sync OK!");
              this.selected = 1;
            break;

            case "USERUPDATE":
              // I am a sync/peer for this user so I keep myself up to date.
              // Overwrite the local userobject with the one received.
              //if(e.detail.detail.partner!=this.openfire1+"@"+this.domein){
              //console.log("Ik  krijg iets van ", e.detail.detail[0].partner);
              //console.log("normaal ga ik dus nu deze shit overschijven: ", e.detail.detail[4].objectdata);
               this.$.localapielem.encdata = e.detail.detail[4].objectdata;
                this.localapi.lastupdate = Date.now();
               // window.location = "/";
              //};
            break;

            case "SYNCUPDATE":
              //console.log("Something changed on another device");
              //console.log("Ken ik stage? ", stage);
              //this.selected = 1;
              this.$.localapielem.encdata = e.detail.detail[4].objectdata;

            break;

            case "VALIDATE":
              // Validate the dataset on this device by adding the sender as a peer
              //console.log("validate request from ", partner);
              //console.log('localapi: ', this.localapi.collection);
              //console.log('objectname: ', objectname);
              //console.log('localapi item: ', this.localapi.collection[objectname]);
              //console.log('peers id: ', e.detail.detail[5].userid);
              this.localapi.collection[objectname].peers.push(e.detail.detail[5].userid);
              this.localapi.lastupdate = Date.now();
              this.$.localapielem.writeData();
            break;

            case "VERIFY":
              // Another user wants a dataset verified by this user
              //console.log("sync request");
              dialog.title = "VERIFY";
              dialog.body = "Wil je getuige zijn van deze dataset?";
              dialog.command = command;
              dialog.partner = e.detail.detail[0].partner;
              dialog.objectname = e.detail.detail[2].objectname;
              dialog.objectdata = e.detail.detail[4].objectdata;
              dialog.userid = e.detail.detail[5].userid;
              dialog.objectconfig = e.detail.detail[3].objectconfig;
              dialog.hash = e.detail.detail[6].hash;
              this.selected = 5;
              //app.openDialog("Wil je deze dataset van Kristien valideren?");
            break;

            case "DATAUPDATE":
              // The incoming dataset has been updated. This device should update the objectconfig and check whether the objectdata has been changed. When changed, the the verification should be cancelled.
              //console.log("sync request");
              dialog.title = "SYNC?";
              dialog.body = "Een toestel wil synchroniseren met dit toestel.";
              //app.localapi.collection[objectname].peers[partner] = objectconfig;
              //console.log("Een van jouw mignons heeft een dataset veranderd.");
              //if(app.localapi.collection[objectname].data === objectdata);
              //app.localapi.lastupdate = Date.now();
            break;

          };

        };
      },


      groupmsgreceived: function(e){
        //console.log(JSON.stringify(e.detail.detail));
        var user = e.detail.userid;
        var object = e.detail.object;
        var hash = e.detail.hash;
        this.$.godf.checkSum(user, object, hash, function(){
          //console.log("okay!");
        });
      },

      cancel: function(){
        this.selected = 4;
      },

      processCommand: function(e){
        // Dit verwerkt het commando dat door de dialog wordt gestuurd.
        var command = e.detail.command;
        var partner = e.detail.partner;
        var objectname = e.detail.objectname;
        var objectdata = e.detail.objectdata;
        var objectconfig = e.detail.objectconfig;
        var userid2 = e.detail.userid;
        var hash = e.detail.hash;
        var loxmpp = this.$.loxmpp;

        //console.log("Process command: ",command);

        switch(command){
          case "SYNC":
            //console.log("confirmation to ", command, " for ", partner);

            this.localapi.peers.push(this.openfire1+'@'+this.domein);
            this.localapi.peers.push(partner);
            this.$.localapielem.writeData();
            var data = this.$.localapielem.encdata;
            var encruserid = this.encruserid;
            loxmpp.sendMessage(partner, "USERUPDATE", "ALL", encruserid, data);
            this.$.localapielem.readData();
          break;

          case "VERIFY":
            //console.log("Ik word getuige van ", userid2);
            //(user1, user2, objectname, objecthash)
            loxmpp.sendMessage(partner, "VALIDATE", objectname, null, null, this.userid, null);
            //loxmpp.sendgroupMessage(this.userid, userid2, objectname, hash);
            //console.log("dus ik push naar godfather array: ", userid2, objectname, hash);
            this.localapi.godfather.push({ "child": userid2, "object": objectname, "hash": hash, "valid": true });
            //this.$.localapielem.readData();
          break;
          
        };
        
      }

    });
})();
</script>
